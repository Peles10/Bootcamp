import { ChartType, } from "@allurereport/charts-api";
import { DEFAULT_ENVIRONMENT } from "@allurereport/core-api";
import { generateBarChart } from "./bar.js";
import { generateComingSoonChart } from "./comingSoon.js";
import { generateHeatMapChart } from "./heatMap.js";
import { generateTrendChart } from "./line.js";
import { generatePieChart } from "./pie.js";
import { generateTreeMapChart } from "./treeMap.js";
const generateChartData = async (props) => {
    const { env, chartsOptions, store, reportName, generateUuid } = props;
    const result = {};
    const storeData = await Promise.all([
        await store.allHistoryDataPoints(),
        env ? await store.testResultsByEnvironment(env) : await store.allTestResults(),
        env ? await store.testsStatistic((tr) => tr.environment === env) : await store.testsStatistic(),
    ]).then(([historyDataPoints, testResults, statistic]) => ({
        historyDataPoints,
        testResults,
        statistic,
    }));
    for (const chartOption of chartsOptions) {
        const chartId = generateUuid();
        switch (chartOption.type) {
            case ChartType.Trend:
                result[chartId] = generateTrendChart(chartOption, storeData, reportName);
                break;
            case ChartType.Pie:
                result[chartId] = generatePieChart(chartOption, storeData);
                break;
            case ChartType.Bar:
                result[chartId] = generateBarChart(chartOption, storeData);
                break;
            case ChartType.TreeMap:
                result[chartId] = generateTreeMapChart(chartOption, storeData);
                break;
            case ChartType.HeatMap:
                result[chartId] = generateHeatMapChart(chartOption, storeData);
                break;
            default:
                result[chartId] = generateComingSoonChart(chartOption);
                break;
        }
        if (!result[chartId]) {
            result[chartId] = generateComingSoonChart(chartOption);
        }
    }
    return result;
};
const hasOnlyDefaultEnvironment = (environments) => {
    return environments.length === 1 && environments[0] === DEFAULT_ENVIRONMENT;
};
export const generateCharts = async (chartsOptions, store, reportName, generateUuid) => {
    const environments = await store.allEnvironments();
    const chartsData = {
        general: await generateChartData({ chartsOptions, store, reportName, generateUuid }),
        byEnv: {},
    };
    if (hasOnlyDefaultEnvironment(environments)) {
        return chartsData;
    }
    for (const environment of environments) {
        chartsData.byEnv[environment] = await generateChartData({
            chartsOptions,
            store,
            reportName,
            env: environment,
            generateUuid,
        });
    }
    return chartsData;
};
