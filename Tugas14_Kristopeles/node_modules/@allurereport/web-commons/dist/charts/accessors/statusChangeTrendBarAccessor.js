import { BarGroupMode, } from "@allurereport/charts-api";
import { capitalize } from "@allurereport/core-api";
import { createEmptyStats } from "../chart-utils.js";
const newGroupKeys = ["newPassed", "newFailed", "newBroken", "newSkipped", "newUnknown"];
const removedGroupKeys = [
    "removedPassed",
    "removedFailed",
    "removedBroken",
    "removedSkipped",
    "removedUnknown",
];
const groupKeys = [...newGroupKeys, ...removedGroupKeys];
const getNewKey = (status) => {
    const capitalizedStatus = capitalize(status);
    return capitalizedStatus ? `new${capitalizedStatus}` : undefined;
};
const getRemovedKey = (status) => {
    const capitalizedStatus = capitalize(status);
    return capitalizedStatus ? `removed${capitalizedStatus}` : undefined;
};
const isHistoryIdIn = (trs, historyId) => {
    return trs.some((tr) => tr.historyId === historyId);
};
const getDeletedFrom = (trs, hdpTrs) => {
    const stats = createEmptyStats(groupKeys);
    for (const hdpTr of hdpTrs) {
        if (!isHistoryIdIn(trs, hdpTr.historyId)) {
            const key = getRemovedKey(hdpTr.status);
            if (key) {
                stats[key]--;
            }
        }
    }
    return stats;
};
const getNewFrom = (trs, hdpTrs) => {
    const stats = createEmptyStats(groupKeys);
    for (const tr of trs) {
        if (!isHistoryIdIn(hdpTrs, tr.historyId)) {
            const key = getNewKey(tr.status);
            if (key) {
                stats[key]++;
            }
        }
    }
    return stats;
};
const getPointStats = (currentTrs, hdpTrs) => {
    const emptyStats = createEmptyStats(groupKeys);
    const newStats = getNewFrom(currentTrs, hdpTrs);
    const deletedStats = getDeletedFrom(currentTrs, hdpTrs);
    return Object.keys(emptyStats).reduce((acc, key) => {
        const newStat = newStats[key] ?? 0;
        const deletedStat = deletedStats[key] ?? 0;
        acc[key] = newStat + deletedStat;
        return acc;
    }, {});
};
const getCurrentStats = (testResults, hdpTrs) => {
    return {
        groupId: "current",
        ...getPointStats(testResults, hdpTrs),
    };
};
const getHistoricalStats = (hdps) => {
    const trendData = [];
    for (let i = 0; i < hdps.length; i++) {
        const currentHdp = hdps[i];
        const currentHdpTrs = Object.values(currentHdp.testResults);
        const previousHdpTrs = i + 1 < hdps.length ? Object.values(hdps[i + 1].testResults) : [];
        trendData.push({
            groupId: `Point ${hdps.length - i - 1}`,
            ...getPointStats(currentHdpTrs, previousHdpTrs),
        });
    }
    return trendData;
};
const getTrendData = (currentTrs, hdps) => {
    const historicalStats = getHistoricalStats(hdps);
    const previousHdpTrs = hdps.length > 0 ? Object.values(hdps[0].testResults) : [];
    const currentStats = getCurrentStats(currentTrs, previousHdpTrs);
    return [currentStats, ...historicalStats];
};
export const statusChangeTrendBarAccessor = {
    getItems: ({ testResults }, limitedHdps, isFullHistory) => {
        let trendData = getTrendData(testResults, limitedHdps);
        if (!isFullHistory) {
            trendData = trendData.slice(0, -1);
        }
        return trendData.reverse();
    },
    getGroupKeys: () => groupKeys,
    getGroupMode: () => BarGroupMode.Stacked,
};
