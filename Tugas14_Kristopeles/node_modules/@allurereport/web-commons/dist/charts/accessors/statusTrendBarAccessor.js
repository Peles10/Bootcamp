import { BarGroupMode } from "@allurereport/charts-api";
import { htrsByTr } from "@allurereport/core-api";
import { createEmptyStats } from "../chart-utils.js";
const groupKeys = ["passed", "failed", "broken"];
const isGroupKey = (key) => groupKeys.includes(key);
const getSignedValueByStatus = (status) => (status === "passed" ? 1 : -1);
const hasSignificantStatus = (htr) => isGroupKey(htr.status);
const getLastSignificantStatus = (history = []) => {
    const significantHtr = history.find(hasSignificantStatus);
    return significantHtr?.status;
};
const isDifferentStatuses = (currentStatus, lastSignificantStatus) => {
    return (!!lastSignificantStatus &&
        isGroupKey(currentStatus) &&
        isGroupKey(lastSignificantStatus) &&
        currentStatus !== lastSignificantStatus);
};
const getPointStats = (currentTrs, hdps) => {
    const stats = createEmptyStats(groupKeys);
    for (const tr of currentTrs) {
        const htrs = htrsByTr(hdps, tr);
        const currentStatus = tr.status;
        const lastSignificantStatus = getLastSignificantStatus(htrs);
        if (isDifferentStatuses(currentStatus, lastSignificantStatus)) {
            stats[currentStatus] = stats[currentStatus] + getSignedValueByStatus(currentStatus);
        }
    }
    return stats;
};
const getCurrentStats = (testResults, hdps) => {
    return {
        groupId: "current",
        ...getPointStats(testResults, hdps),
    };
};
const getHistoricalStats = (hdps) => {
    const trendData = [];
    for (let i = 0; i < hdps.length; i++) {
        const currentHdp = hdps[i];
        const currentHdpTrs = Object.values(currentHdp.testResults);
        const restHdps = i + 1 < hdps.length ? hdps.slice(i + 1, hdps.length) : [];
        trendData.push({
            groupId: `Point ${hdps.length - i - 1}`,
            ...getPointStats(currentHdpTrs, restHdps),
        });
    }
    return trendData;
};
const getTrendData = (currentTrs, hdps) => {
    const historicalStats = getHistoricalStats(hdps);
    const currentStats = getCurrentStats(currentTrs, hdps);
    return [currentStats, ...historicalStats];
};
export const statusTrendBarAccessor = {
    getItems: ({ testResults }, limitedHdps, isFullHistory) => {
        let trendData = getTrendData(testResults, limitedHdps);
        if (!isFullHistory) {
            trendData = trendData.slice(0, -1);
        }
        return trendData.reverse();
    },
    getGroupKeys: () => groupKeys,
    getGroupMode: () => BarGroupMode.Stacked,
};
